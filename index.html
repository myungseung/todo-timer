<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Simple Pomodoro Timer with Todo List">
  <meta name="theme-color" content="#09090b">
  <title>üçÖ Pomodoro Todo Timer</title>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/charts.css/dist/charts.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
      background: #09090b;
      color: #fafafa;
      height: 100vh;
      padding: 24px;
      line-height: 1.5;
      overflow: hidden;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    /* Timer Section */
    .timer-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      min-height: 370px;
    }

    .timer-clock {
      width: 250px;
      height: 250px;
      position: relative;
      flex-shrink: 0;
    }

    /* Chart background */
    #timer-chart tbody {
      background: #09090b;
      transform: scaleX(-1) rotate(60deg);
    }

    /* Color customization only */
    #timer-chart tr:nth-child(1) {
      --color: #09090b;
    }

    #timer-chart tr:nth-child(2) {
      --color: #ef4444;
    }

    /* Timer ticks */
    .timer-ticks {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    .tick {
      position: absolute;
      background: #3f3f46;
      left: 50%;
      top: -10px;
      transform-origin: 50% 135px;
      margin-left: -1px;
    }

    .tick.minute {
      width: 2px;
      height: 10px;
    }

    .tick.five-minute {
      width: 3px;
      height: 15px;
      background: #52525b;
      margin-left: -1.5px;
      top: -15px;
      transform-origin: 50% 140px;
    }

    /* Digital timer display */
    .digital-timer {
      text-align: center;
      margin-top: 24px;
      font-size: 20px;
      font-weight: 600;
      color: #a1a1aa;
      font-variant-numeric: tabular-nums;
      flex-shrink: 0;
      transition: color 0.2s;
    }

    .digital-timer.running {
      color: #ef4444;
    }


    .stats {
      display: flex;
      gap: 20px;
      align-items: center;
      font-size: 12px;
      color: #71717a;
      padding: 12px 0;
      border-bottom: 1px solid #27272a;
      margin-bottom: 12px;
      flex-shrink: 0;
    }

    .stat-item {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .stat-label {
      color: #71717a;
    }

    .stat-value {
      font-weight: 600;
      color: #a1a1aa;
      font-variant-numeric: tabular-nums;
    }

    /* Todo Section */
    .todo-section {
      background: #18181b;
      border: 1px solid #27272a;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
      flex-shrink: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 150px;
      max-height: calc(100vh - 418px);
    }

    .todo-list {
      list-style: none;
      flex: 1;
      overflow-y: auto;
      min-height: 0;
    }

    .todo-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      border-radius: 6px;
      margin-bottom: 2px;
      transition: all 0.2s;
      position: relative;
      border: 1px solid transparent;
      min-height: 44px;
    }

    .todo-item:hover {
      background: #27272a;
    }

    .todo-item.active {
      background: rgba(239, 68, 68, 0.1);
      border-left: 3px solid #ef4444;
    }

    .todo-item:focus-within {
      background: #27272a;
      border: 1px solid #3f3f46;
    }

    .checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
      flex-shrink: 0;
      accent-color: #ef4444;
      -webkit-appearance: none;
      appearance: none;
      border: 2px solid #52525b;
      border-radius: 4px;
      background: transparent;
      position: relative;
    }

    .checkbox:checked {
      background: #ef4444;
      border-color: #ef4444;
    }

    .checkbox:checked::after {
      content: '';
      position: absolute;
      left: 5px;
      top: 2px;
      width: 4px;
      height: 8px;
      border: solid #fafafa;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
    }

    .todo-input {
      flex: 1;
      background: transparent;
      border: none;
      color: #fafafa;
      font-size: 15px;
      outline: none;
      font-family: inherit;
      padding: 2px 0;
      cursor: text;
      pointer-events: auto;
    }

    .todo-input:focus {
      outline: none;
    }

    .todo-input::placeholder {
      color: #52525b;
    }

    .todo-item.completed .todo-input {
      text-decoration: line-through;
      color: #71717a;
    }

    .todo-item.level-1 {
      padding-left: 44px;
    }

    .todo-item.level-2 {
      padding-left: 76px;
    }

    .todo-item.level-3 {
      padding-left: 108px;
    }


    .pom-badge {
      display: flex;
      align-items: center;
      gap: 4px;
      background: #09090b;
      border: 1px solid #27272a;
      border-radius: 6px;
      padding: 3px 8px;
      font-size: 13px;
      color: #a1a1aa;
      white-space: nowrap;
      font-variant-numeric: tabular-nums;
      flex-shrink: 0;
    }

    /* Popup */
    .popup {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(4px);
    }

    .popup.show {
      display: flex;
    }

    .popup-content {
      background: #18181b;
      border: 1px solid #27272a;
      border-radius: 12px;
      padding: 32px;
      text-align: center;
      max-width: 400px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.7);
    }

    .popup-title {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .popup-text {
      font-size: 15px;
      color: #a1a1aa;
      margin-bottom: 24px;
      line-height: 1.6;
    }

    .popup-btn {
      background: #ef4444;
      color: #fafafa;
      border: none;
      border-radius: 6px;
      padding: 10px 24px;
      font-size: 14px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s;
    }

    .popup-btn:hover {
      background: #dc2626;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Timer Section -->
    <div class="timer-section">
      <div class="timer-clock">
        <table class="charts-css pie hide-data" id="timer-chart">
          <tbody>
            <tr id="elapsed-row">
              <td style="--start: 0; --end: 0;"><span class="data"></span></td>
            </tr>
            <tr id="remaining-row">
              <td style="--start: 0; --end: 0.8333;"><span class="data"></span></td>
            </tr>
          </tbody>
        </table>
        <div class="timer-ticks" id="timerTicks"></div>
      </div>
      <div class="digital-timer" id="digitalTimer">50:00</div>
    </div>

    <!-- Todo Section -->
    <div class="todo-section">
      <div class="stats">
        <div class="stat-item">
          <span class="stat-label">ÏôÑÎ£åÏú®</span>
          <span class="stat-value" id="completionRate">0%</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Ï¥ù ÏÜåÏöî ÏãúÍ∞Ñ</span>
          <span class="stat-value" id="totalTime">0h 0m</span>
        </div>
        <div class="stat-item" style="margin-left: auto;">
          <span class="stat-value" id="totalPomCount">üçÖ 0.0</span>
        </div>
      </div>
      <ul class="todo-list" id="todoList"></ul>
    </div>
  </div>

  <!-- Popup -->
  <div class="popup" id="popup">
    <div class="popup-content">
      <div class="popup-title">‚è∞</div>
      <div class="popup-text">ÏãúÍ∞ÑÏù¥ Ï¥àÍ≥ºÎêòÏóàÏäµÎãàÎã§!<br>25Î∂ÑÏùÑ Ï∂îÍ∞ÄÎ°ú Ï†úÍ≥µÌï©ÎãàÎã§.</div>
      <button class="popup-btn" onclick="continueTimer()">Í≥ÑÏÜçÌïòÍ∏∞</button>
    </div>
  </div>

  <script>
    // State
    let todos = [];
    let timerSeconds = 50 * 60;
    let timerInterval = null;
    let currentTodoId = null;
    let totalTimeSpent = 0;
    let focusedIndex = 0;
    let timerState = 'stopped'; // 'stopped', 'running'
    let currentTimerStartTime = 0;
    const POMODORO_TIME = 50 * 60;
    const EXTRA_TIME = 25 * 60;

    // Initialize
    function init() {
      loadFromStorage();
      renderTodos();
      updateStats();
      addFirstTodo();
      initTimerUI();
      document.addEventListener('keydown', handleGlobalKeyDown);
    }

    // Initialize Timer UI
    function initTimerUI() {
      // Create ticks (60 minutes)
      const ticksContainer = document.getElementById('timerTicks');
      for (let i = 0; i < 60; i++) {
        const tick = document.createElement('div');
        tick.className = i % 5 === 0 ? 'tick five-minute' : 'tick minute';
        tick.style.transform = `rotate(${i * 6 - 60}deg)`;
        ticksContainer.appendChild(tick);
      }

      // Set initial timer (50 minutes = 5/6 of 60 minutes)
      currentTimerStartTime = POMODORO_TIME;
      timerSeconds = POMODORO_TIME;
      updateTimerUI();
    }

    // Add first empty todo
    function addFirstTodo() {
      if (todos.length === 0) {
        addTodo(null, 0);
      }
    }

    // Global keyboard handler
    function handleGlobalKeyDown(e) {
      // Timer toggle (Cmd+Enter) works everywhere
      if (e.metaKey && e.key === 'Enter') {
        e.preventDefault();
        handleTimerToggle();
        return;
      }

      // Arrow keys only when not typing in input
      if (e.target.tagName === 'INPUT') {
        // Allow all normal typing in input
        if (e.key !== 'ArrowUp' && e.key !== 'ArrowDown') {
          return;
        }
      }

      // Handle arrow key navigation
      if (e.key === 'ArrowUp') {
        e.preventDefault();
        moveFocus(-1);
      } else if (e.key === 'ArrowDown') {
        e.preventDefault();
        moveFocus(1);
      }
    }

    function moveFocus(direction) {
      focusedIndex = Math.max(0, Math.min(todos.length - 1, focusedIndex + direction));
      const input = document.querySelector(`input[data-id="${todos[focusedIndex].id}"]`);
      if (input) input.focus();
    }

    function handleTimerToggle() {
      if (todos.length === 0) return;
      const todo = todos[focusedIndex];
      if (!todo || todo.completed) return;

      if (timerState === 'stopped') {
        startTimer(todo.id);
      } else if (timerState === 'running' && currentTodoId === todo.id) {
        stopTimer();
      } else if (timerState === 'stopped' && currentTodoId === todo.id) {
        restartTimer(todo.id);
      }
    }

    // Timer functions
    function startTimer(todoId) {
      currentTodoId = todoId;
      timerSeconds = POMODORO_TIME;
      currentTimerStartTime = POMODORO_TIME;
      timerState = 'running';
      updateTimerUI();
      document.getElementById('digitalTimer').classList.add('running');

      timerInterval = setInterval(() => {
        timerSeconds--;
        updateTimerUI();

        if (timerSeconds <= 0) {
          pauseTimer();
          showPopup();
        }
      }, 1000);

      renderTodos();
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }

      if (timerState === 'running') {
        const elapsed = currentTimerStartTime - timerSeconds;
        totalTimeSpent += elapsed;

        const todo = todos.find(t => t.id === currentTodoId);
        if (todo) {
          todo.pomCount = (todo.pomCount || 0) + (elapsed / POMODORO_TIME);
        }

        updateStats();
        saveToStorage();
      }

      timerState = 'stopped';
      document.getElementById('digitalTimer').classList.remove('running');
      renderTodos();
    }

    function pauseTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      timerState = 'stopped';
      document.getElementById('digitalTimer').classList.remove('running');
    }

    function restartTimer(todoId) {
      startTimer(todoId);
    }

    function updateTimerUI() {
      // Update digital timer display
      const mins = Math.floor(timerSeconds / 60);
      const secs = timerSeconds % 60;
      document.getElementById('digitalTimer').textContent =
        `${mins}:${secs.toString().padStart(2, '0')}`;

      // Update pie chart based on 60 minutes
      const FULL_CIRCLE_MINUTES = 60 * 60; // 60 minutes in seconds
      const elapsed = currentTimerStartTime - timerSeconds;
      const elapsedRatio = elapsed / FULL_CIRCLE_MINUTES;
      const remainingRatio = timerSeconds / FULL_CIRCLE_MINUTES;

      // Elapsed time (gray segment)
      const elapsedTd = document.querySelector('#elapsed-row td');
      elapsedTd.style.setProperty('--start', '0');
      elapsedTd.style.setProperty('--end', elapsedRatio.toFixed(4));

      // Remaining time (red segment)
      const remainingTd = document.querySelector('#remaining-row td');
      remainingTd.style.setProperty('--start', elapsedRatio.toFixed(4));
      remainingTd.style.setProperty('--end', (elapsedRatio + remainingRatio).toFixed(4));
    }

    function showPopup() {
      document.getElementById('popup').classList.add('show');
    }

    function continueTimer() {
      document.getElementById('popup').classList.remove('show');
      timerSeconds = EXTRA_TIME;
      currentTimerStartTime = EXTRA_TIME;
      timerState = 'running';
      updateTimerUI();
      document.getElementById('digitalTimer').classList.add('running');

      timerInterval = setInterval(() => {
        timerSeconds--;
        updateTimerUI();

        if (timerSeconds <= 0) {
          pauseTimer();
          showPopup();
        }
      }, 1000);
    }

    // Todo functions
    function addTodo(afterId, level) {
      const todo = {
        id: Date.now(),
        text: '',
        completed: false,
        level: level,
        pomCount: 0
      };

      if (afterId === null) {
        todos.push(todo);
      } else {
        const index = todos.findIndex(t => t.id === afterId);
        todos.splice(index + 1, 0, todo);
      }

      saveToStorage();
      renderTodos();

      setTimeout(() => {
        const input = document.querySelector(`input[data-id="${todo.id}"]`);
        if (input) input.focus();
      }, 0);
    }

    function deleteTodo(id) {
      const index = todos.findIndex(t => t.id === id);
      if (index === -1) return;

      const level = todos[index].level;
      let deleteCount = 1;

      for (let i = index + 1; i < todos.length; i++) {
        if (todos[i].level <= level) break;
        deleteCount++;
      }

      todos.splice(index, deleteCount);

      // Focus next or previous todo
      let nextFocusIndex = index;
      if (index >= todos.length) {
        nextFocusIndex = todos.length - 1;
      }

      focusedIndex = Math.max(0, nextFocusIndex);

      saveToStorage();
      renderTodos();
      updateStats();

      // Focus after render
      setTimeout(() => {
        if (todos.length > 0) {
          const input = document.querySelector(`input[data-id="${todos[focusedIndex].id}"]`);
          if (input) input.focus();
        } else {
          addTodo(null, 0);
        }
      }, 0);
    }

    function toggleTodo(id) {
      const todo = todos.find(t => t.id === id);
      if (!todo) return;

      todo.completed = !todo.completed;

      if (todo.completed && currentTodoId === id) {
        stopTimer();
      }

      saveToStorage();
      renderTodos();
      updateStats();
    }

    function updateTodoText(id, text) {
      const todo = todos.find(t => t.id === id);
      if (todo) {
        todo.text = text;
        saveToStorage();
      }
    }

    function renderTodos() {
      const list = document.getElementById('todoList');
      list.innerHTML = '';

      todos.forEach((todo, index) => {
        const li = document.createElement('li');
        li.className = `todo-item level-${todo.level}`;
        if (todo.completed) li.classList.add('completed');
        if (currentTodoId === todo.id && timerState === 'running') li.classList.add('active');

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'checkbox';
        checkbox.checked = todo.completed;
        checkbox.onchange = () => toggleTodo(todo.id);

        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'todo-input';
        input.placeholder = 'New task...';
        input.value = todo.text;
        input.dataset.id = todo.id;
        input.oninput = (e) => updateTodoText(todo.id, e.target.value);
        input.onkeydown = (e) => handleKeyDown(e, todo.id, todo.level);
        input.onclick = (e) => {
          e.stopPropagation();
          focusedIndex = index;
        };
        input.onfocus = () => {
          focusedIndex = index;
        };

        li.appendChild(checkbox);
        li.appendChild(input);

        // Pomodoro badge
        if (todo.pomCount > 0) {
          const badge = document.createElement('div');
          badge.className = 'pom-badge';
          badge.innerHTML = `üçÖ ${todo.pomCount.toFixed(1)}`;
          li.appendChild(badge);
        }

        list.appendChild(li);
      });
    }

    function handleKeyDown(e, id, level) {
      // Enter: Create new todo
      if (e.key === 'Enter' && !e.shiftKey && !e.metaKey) {
        e.preventDefault();
        addTodo(id, level);
        return;
      }

      // Tab: Indent (create subtask)
      if (e.key === 'Tab' && !e.shiftKey) {
        e.preventDefault();
        const todo = todos.find(t => t.id === id);
        if (todo && level < 3) {
          todo.level = level + 1;
          saveToStorage();
          renderTodos();
          setTimeout(() => {
            const input = document.querySelector(`input[data-id="${id}"]`);
            if (input) input.focus();
          }, 0);
        }
        return;
      }

      // Backspace on empty: Delete todo
      if (e.key === 'Backspace' && e.target.value === '') {
        e.preventDefault();
        deleteTodo(id);
        return;
      }
    }

    // Stats
    function updateStats() {
      const completed = todos.filter(t => t.completed).length;
      const total = todos.length;
      const rate = total > 0 ? Math.round((completed / total) * 100) : 0;

      const hours = Math.floor(totalTimeSpent / 3600);
      const mins = Math.floor((totalTimeSpent % 3600) / 60);

      const totalPom = todos.reduce((sum, t) => sum + (t.pomCount || 0), 0);

      document.getElementById('completionRate').textContent = `${rate}%`;
      document.getElementById('totalTime').textContent = `${hours}h ${mins}m`;
      document.getElementById('totalPomCount').textContent = `üçÖ ${totalPom.toFixed(1)}`;
    }

    // Storage
    function saveToStorage() {
      localStorage.setItem('todos', JSON.stringify(todos));
      localStorage.setItem('totalTimeSpent', totalTimeSpent.toString());
    }

    function loadFromStorage() {
      const stored = localStorage.getItem('todos');
      if (stored) todos = JSON.parse(stored);

      const time = localStorage.getItem('totalTimeSpent');
      if (time) totalTimeSpent = parseInt(time);
    }

    // Start
    init();

    // Register Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js')
        .then(() => console.log('Service Worker registered'))
        .catch(err => console.log('Service Worker registration failed:', err));
    }
  </script>
</body>
</html>

